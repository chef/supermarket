# Configuring Supermarket

These instructions show how to configure Supermarket in development mode. If
running in a production-like environment, you'll be using the Omnibus
package install, where these settings are driven through
/etc/supermarket/supermarket.rb.

Supermarket uses [dotenv](https://github.com/bkeepers/dotenv) to handle setting
environment variables. These are the different configurations needed to get
Supermarket running. The default parameters provided in `.env` should be
sufficient to run the test suite.


## Recommended System Specs

If you are running Supermarket in a production environment, these are the minimum, basic specifications we recommend for your Supermarket server:
* At least 1 CPU
* At least 1 GB Memory
* At least 5 GB free space in /var

## Minimum Viable Configuration

It is recommended to set these parameters to valid values to be able to use the
core functionality of Supermarket.

* `GITHUB_KEY` and `GITHUB_SECRET` are generated by registering an application
  on GitHub. A GitHub application is required so that users can link their
  GitHub accounts to their Supermarket account.
* The `DEVISE_SECRET_KEY` is used by Devise for security purposes. When
  developing locally, feel free to set it to anything.
* The `SECRET_KEY_BASE` is similar to the `DEVISE_SECRET_KEY`, but is for
  Rails. Set it to whatever you want in development.
* `CHEF_OAUTH2_URL` is the URL for your Chef server (example:
  https://example.com.) Enterprise Chef >= 11.2 or Chef server >= 12 is
  required.
* `CHEF_OAUTH2_APP_ID` and `CHEF_OAUTH2_SECRET` are generated when [registering
  an application on oc-id](https://id.chef.io/id/oauth/applications/). They
  are needed for authentication via OAuth2. When using the application locally,
  be sure to create an application and set the callback url to
  `http://localhost:3000/auth/chef_oauth2/callback` or whatever localhost domain
  you use.
* `STATSD_URL` and `STATSD_PORT` may be used to configure a StatsD server which Supermarket
  will report various statistics to, currently API and web download counts.
* `CLA_REPORT_EMAIL` an email address where a monthly report of new CLA signers will be sent.

  **NOTE** oc-id is still a work-in-progress; as such, you may find that you are unable to register an application. If this is the case, see [#425](https://github.com/chef/supermarket/issues/550) for a discussion on how to bypass OAuth for now.
* `CCLA_VERSION` and `ICLA_VERSION` set the version of the current CCLA and
  ICLA respectively.

### Environment Overrides

If you would like to override the defaults in a particular Rails environment,
dotenv will give the settings in `.env.#{Rails.env}` precedence over those in
`.env`. Supermarket explicitly ignores `.env.development` and `.env.test`. This
means that you could, for example, specify an oc-id app ID and secret for local
development in a way that does not soil your working directory by placing the
following in `.env.development`:

```
CHEF_OAUTH2_APP_ID=MY_DEVELOPMENT_KEY
CHEF_OAUTH2_SECRET=MY_DEVELOPMENT_SECRET
```

## Mail Settings

Your Supermarket will use email to send notifications to users (i.e. when a cookbook is up for adoption and someone expresses interest, an email will be sent to the cookbook's current owner)

Configure a local mail transfer agent (Postfix works well!) on your Supermarket server using the steps appropriate for the platform on which your Supermarket server is running.

### Admin Users
Admin users can create other admin users and can change the ownership of cookbooks.

To create your FIRST (and only your first) admin user, you will need to use
a supermarket-ctl task.

1. First, ssh into your Supermarket Server
2. Run this command, subsituting in the username you wish to make an admin

```
$ supermarket-ctl make-admin supermarket_username
```
To make more admin users, an existing admin user should access the user's profile
page in the Supermarket GUI (https://your-supermarket-server/users/user_name),
then click the big "Make Admin" button in the left hand menu on the screen.

## Production Settings

These settings are recommended when deploying Supermarket to a production
environment. Any defaults provided in `.env` should be sufficient for running
the test suite.

* `SENTRY_URL` is the URL for logging for the error logger
  [Sentry](https://getsentry.com/). In development, it is okay not to set it.
* `CLA_SIGNATURE_NOTIFICATION_EMAIL` is the email that gets notified when CLAs
  are signed.
* `FROM_EMAIL` is the default sender email address for all Supermarket mailers.
* `S3_BUCKET` specifies the S3 bucket to use to save uploaded cookbook artifacts
* `S3_PATH` specifies the path in the S3 Bucket to save the uploaded cookbook artifacts to (i.e. if you had a test/supermarket folder (also known as a directory or a prefix) in your bucket that you wanted to save your cookbooks to, you would use "test/supermarket" as your path).
* `S3_ACCESS_KEY_ID` and `S3_SECRET_ACCESS_KEY` are the keys required to put
  files in the above bucket.
* `S3_URLS_EXPIRE` is used if you want to use expiring urls for your cookbook
  artifacts when someone downloads them.
* `S3_PRIVATE_OBJECTS` is used if you want to set permissions on your cookbook
  artifacts as 'private'.  Note that this will set this ACL as private on your
  cookbook object itself, which may conflict with a bucket policy if you use one
  on your bucket.  If you wish to use a bucket policy, rather than an object policy,
  leave this variable as nil.
* `CDN_URL` Used to configure a CDN URL for use with Paperclip. Downloads
  will be aliased with this URL, something like `static.chef.io`.
* `FIERI_URL` is the URL Supermarket will `POST` to for Cookbook evaluation when
  a cookbook is shared

## Turning off 3rd party services

If you are in an air-gapped environment or another situation where you cannot
have your Supermarket call out to 3rd party services (i.e. fonts, Google Analytics)
* `AIR_GAPPED` can be set to true to avoid calls to 3rd party services.  It is set to false by default.

## Configuring Curry

Curry verifies that all contributing parties on a Pull Request have signed a
CLA. The default values provided in `.env` should be sufficient to run the test
suite.

* `GITHUB_ACCESS_TOKEN` is used for interacting with the GitHub API.
  Supermarket uses the GitHub API for CLA signature verification checking.
  Generate a personal access token within Account Settings > Applications >
  Personal Access Tokens. **This must be set to run Supermarket locally.**
* `PUBSUBHUBBUB_SECRET` is used for Supermarket to subscripe to repositories.
  It can be set to anything in development.
* `PUBSUBHUBBUB_CALLBACK_URL` is intended for development and test
  environments. When Curry subscribes to a respository, this URL will receive
  periodic heartbeats from GitHub, as well as notifications of Pull Request
  activity. In production, it is best left unspecified, in which case
  Supermarket will use the `curry_pull_request_updates_url`.
* `CURRY_SUCCESS_LABEL` is the text of the label Curry will add to Pull
  Requests whose contributors have all signed a CLA.

## SMTP Settings

By default, Supermarket will use sendmail to send emails. If any of the below
environment variables are specified, Supermarket will send email via SMTP
instead.

* `SMTP_ADDRESS`
* `SMTP_PORT`
* `SMTP_USER_NAME`
* `SMTP_PASSWORD`

## New Relic Configuration

Supermarket bundles the NewRelic agent and uses two environment variables in
its configuration.

* `NEW_RELIC_LICENSE_KEY`
* `NEW_RELIC_APP_NAME`, which defaults to `Supermarket`

## Supermarket Feature Configuration

Certain features of Supermarket can be enabled or disabled using `FEATURES`. The
`FEATURES` ENV variable should be defined as a comma separated list of features to
be enabled. Supermarket supports the following features.

* `cla`, Enables the ability to sign the ICLA and CCLA, as well as Curry
* 'gravatar', Enables Supermarket to use gravatars for user avatar icons
* `tools`, Enables the ability to add and view Chef tools and plugins.
* `join_ccla`, Enables the ability for users to join CCLAs that they don't be long to.
* `no_crawl`, Adds noindex, nofollow meta tags so search engines won't crawl Supermarket.
* `fieri`, Enables the ability for Cookbook Versions to be evaluated by Fieri
* `announcement`, Enables the foldable annoucement banner that is displayed on all views.
  when uploaded
* `collaborator_groups`, Enables collaborator groups, which allow you to manage collaborators
   through groups

## Debugging

If you are having any issues with Supermarket, you can debug it using the Rails log.  However, the way you access it in Supermarket is different from how you would access it in most Rails applications.

First, you will need to change the log level to 'DEBUG'.  You do this by setting the environmental variable `LOG_LEVEL` to 'DEBUG'

Once you do this, run:
```
  $ supermarket-ctl reconfigure
```

Once the reconfigure is complete, run this command to tail the logs.  You should now see any logger debug statements in the Supermarket Rails application.
```
  $ supermarket-ctl tail
```
